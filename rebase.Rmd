---
title: "Git rebase"
output: 
  html_document:
   toc: true
   toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(tidyverse)
```



# Rebase : réécrire l'histoire

La commande `git rebase` permet de réécrire l'histoire des commits, par exemple pour la rendre plus lisible. 

Pour éviter les soucis de compatibilité on évite de réécrire une histoire publique. On ne fait des rebase que sur des branches qui ne sont pas liées aux autres.

# Un exemple d'utilisation de rebase : le merge

Classiquement quand on merge une branche test dans master on a un historique de commit comme dans la figure suivante


<img src="resources/figs/git8.svg" width="800" height = "250" alt = "simple branche"></img>


Si cette situation se reproduit de nombreuses fois sur de nombreuses branches le graphe des commits devient vite illisible. Pour faciliter la vision de l'historique du projet on peut modifier cet arbre.



<img src="resources/figs/git8_rebase.svg" width="800" height = "250" alt = "simple branche"></img>


# En pratique 

Pour réussir facilement cette tâche, il suffit se positionner sur la branche test et on va faire comme si on avait commencé à développer test à partir de la dernière version de master

```{r rebase1, eval = FALSE}
git switch test
git rebase master
```

A l'issue de cette opération, test est une succession de changements initiés depuis la dernière version de master. En fussionnant master et test, on va juste faire avancer master de quelques commits on n'aura as de commit de merge.

```{r rebase2, eval = FALSE}
git switch master
git merge test
```



<img src="resources/figs/git8_rebase_merge.svg" width="800" height = "250" alt = "simple branche"></img>


# Pour aller plus loin

Le rebase permet de réécrire toute l'histoire des commits. Si l'on souhaite modifier les 5 derniers commits. Par exemple dans la branche rebase voici l'historique des 5 derniers commits.

```{r log, eval=FALSE, echo = TRUE}
metienne@RMATHMPE20:~/git/finistR2022$ git log -n 5 --oneline
423f7a1 (HEAD -> rebase) Add git8 rebase merge illustration
3ebd174 Add git8 rebase  illustration
a535bf1 Add git8 merge bifucation illustration
d3ae968 git rebase fast forward
2a0b55e (origin/master, master) Add build directory to .gitignore
```


Il m'a fallu 3 commits pour ajouter les images, je n'ai pas envie de garder cet historique inutile, je voudrais un seul commit qui inclut toutes les images. je peux utiliser rebase pour faire ceci. La commande suivante, demande rentrer dans un mode de rebase automatique à partir pour les 5 derniers commits.

```{r rebase_i}
git rebase --interactive HEAD~5
```

On a alors accès aux derniers commits ouvert dans un éditeur de texte (attention ils sont dans l'ordre inverse, le plus récent en bas). Pour réécrire l'histoire il suffit de modifier le mot clé pick par une des propositions ci dessous.

```{r rebase_inter_res, echo = TRUE}
pick 2a0b55e Add build directory to .gitignore
pick d3ae968 git rebase fast forward
pick a535bf1 Add git8 merge bifucation illustration
pick 3ebd174 Add git8 rebase  illustration
pick 423f7a1 Add git8 rebase merge illustration

# Rebase cefde40..423f7a1 onto 3ebd174 (5 commands)
#
# Commands:
# p, pick <commit> = use commit
# r, reword <commit> = use commit, but edit the commit message
# e, edit <commit> = use commit, but stop for amending
# s, squash <commit> = use commit, but meld into previous commit
# f, fixup <commit> = like "squash", but discard this commit's log message
# x, exec <command> = run command (the rest of the line) using shell
# b, break = stop here (continue rebase later with 'git rebase --continue')
# d, drop <commit> = remove commit
# l, label <label> = label current HEAD with a name
# t, reset <label> = reset HEAD to a label
# m, merge [-C <commit> | -c <commit>] <label> [# <oneline>]
                               [ Read 31 lines ]
^G Get Help  ^O Write Out ^W Where Is  ^K Cut Text  ^J Justify   ^C Cur Pos
^X Exit      ^R Read File ^\ Replace   ^U Paste Text^T To Spell  ^_ Go To Line

```



Pour ne faire qu'un seul commit de mes 3 ajouts de fichier, je vais utiliser ` squash`


```{r rebase_inter_res, echo = TRUE}
pick 2a0b55e Add build directory to .gitignore
pick d3ae968 git rebase fast forward
pick a535bf1 Add git8 merge bifucation illustration
s 3ebd174 Add git8 rebase  illustration
f 423f7a1 Add git8 rebase merge illustration

# Rebase cefde40..423f7a1 onto 3ebd174 (5 commands)
#
# Commands:
# p, pick <commit> = use commit
# r, reword <commit> = use commit, but edit the commit message
# e, edit <commit> = use commit, but stop for amending
# s, squash <commit> = use commit, but meld into previous commit
# f, fixup <commit> = like "squash", but discard this commit's log message
# x, exec <command> = run command (the rest of the line) using shell
# b, break = stop here (continue rebase later with 'git rebase --continue')
# d, drop <commit> = remove commit
# l, label <label> = label current HEAD with a name
# t, reset <label> = reset HEAD to a label
# m, merge [-C <commit> | -c <commit>] <label> [# <oneline>]
                               [ Read 31 lines ]
^G Get Help  ^O Write Out ^W Where Is  ^K Cut Text  ^J Justify   ^C Cur Pos
^X Exit      ^R Read File ^\ Replace   ^U Paste Text^T To Spell  ^_ Go To Line

```




